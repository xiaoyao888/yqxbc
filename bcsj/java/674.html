<!DOCTYPE html>
<html>
<head>
  <title>Java中SimpleDateFormat安全的时间格式化</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="keywords" content="Java,SimpleDateFormat,时间格式" />
  <meta name="description" content="想必大家对SimpleDateFormat并不陌生。SimpleDateFormat 是 " />
  <link href="/templets/default/css/bootstrap.min.css" rel="stylesheet">
  <link href="/templets/default/css/bootstrap-theme.min.css" rel="stylesheet">
  <link href="/templets/default/css/theme.css" rel="stylesheet">
  <link href="/templets/default/css/main.css" rel="stylesheet">
  <link href="/templets/default/css/animate.css" rel="stylesheet">
  <link href="/templets/default/css/header.css" rel="stylesheet">
</head>
<body>
  <header id="header" class="site-header">
    <div class="container" style="margin-top:0px;">
      <div class="row">
        <div class="col-sm-12 col-md-12">
          <div class="site-header-banner" style="min-height:170px;">
            <h2 class="title-site-name swing animated" id="title-site-name">一起学编程</h2>
            <div class="title-site-domain" id="title-site-domain">www.yqxbc.com</div>
            <div class="title-site-memo" id="title-site-memo">常用技术，开发中遇到的坑，你想要的或许这里有。</div>
          </div>
        </div>
      </div>
    </div>
    <nav class="navbar navbar-default navbar-custom">
      <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header navbar-header-custom">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">首页</a>
        </div>
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav nav-custom">
            <li class="dropdown">
              <a href="/bcsj" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">编程设计<span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li><a href="/bcsj/css/" title="CSS">CSS</a> </li>
                <li><a href="/bcsj/hadoop/" title="Hadoop">Hadoop</a> </li>
                <li><a href="/bcsj/ajax/" title="Ajax">Ajax</a> </li>
                <li><a href="/bcsj/js/" title="Javascript">Javascript</a> </li>
                <li><a href="/bcsj/java/" title="Java">Java</a> </li>
                <li><a href="/bcsj/jetty/" title="Jetty">Jetty</a> </li>
                <li><a href="/bcsj/python/" title="Python">Python</a> </li>
                <li><a href="/storm/" title="Storm">Storm</a> </li>
                <li><a href="/elasticsearch/" title="ElasticSearch">ElasticSearch</a> </li>
                <li><a href="/SpringBoot/" title="SpringBoot">SpringBoot</a> </li>
                <li><a href="/sublime/" title="Sublime">Sublime</a> </li>
                <li><a href="/springcloud/" title="SpringCloud">SpringCloud</a> </li>
                <li><a href="/zookeeper/" title="ZooKeeper">ZooKeeper</a> </li>
                <li><a href="/git/" title="Git">Git</a> </li>
                <li><a href="/maven/" title="Maven">Maven</a> </li>
                <li><a href="/gradle/" title="Gradle">Gradle</a> </li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="/shujuku" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">数据库 <span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li><a href="/shujuku/redis/" title="redis">redis</a> </li>
                <li><a href="/shujuku/sqlserver/" title="SQL Server">SQL Server</a> </li>
                <li><a href="/shujuku/memcache/" title="Memcache">Memcache</a> </li>
                <li><a href="/shujuku/mysql/" title="MySql">MySql</a> </li>
                <li><a href="/shujuku/oracle/" title="Oracle">Oracle</a> </li>
                <li><a href="/shujuku/mangodb/" title="MangoDB">MangoDB</a> </li>
                <li><a href="/shujuku/hbase/" title="Hbase">Hbase</a> </li>
                <li><a href="/shujuku/access/" title="Access">Access</a> </li>
                <li><a href="/shujuku/db2/" title="DB2">DB2</a> </li>
              </ul>
            </li>
            <li><a href="/dnzs" target="_blank" title="电脑基础知识学习，计算机技术学习网站，计算机基础知识,电脑学习">电脑知识 <span class="sr-only">(current)</span></a></li>
            <li><a href="/wlzs" target="_blank" title="网络知识大全">网络知识</a></li>
            <li><a href="http://www.win10os.com"target="_blank" title="windows10系统">windows10</a></li>
            <li><a href="/czxt/linux" target="_blank" title="linux系统">linux</a></li>
            <li><a href="/erweima/" target="_blank" title="二维码生成">常用工具</a></li>
          </ul>
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container-fluid -->
    </nav>
  </header><!-- /header -->

  <div class="modal fade" id="imgModal" tabindex="-1" role="dialog" aria-hidden="true">
	   <div class="modal-dialog">
		  <div class="modal-content">
			 <div class="modal-body">
				<div id="modal_img" ></div>
			 </div>
		  </div>
	   </div>
	</div>
  <div class="container" style="padding-left:0px;padding-right:0px">
    
    <div class="col-sm-8  col-md-8">
      <div class="panel panel-default">
        <div class="panel-body">
          <div class="art_title">
            <div>Java中SimpleDateFormat安全的时间格式化</div>
            <a href="/">yqxbc</a>  发布时间：05-07 来源：一起学编程 浏览：21次
          </div>
          <div class="art_body">
            <div class="col-md-12 well bg-success" role="complementary">
              <h3>文章目录</h3>
            	<nav>
            		<ul id="rootul" class="nav bs-docs-sidenav"></ul>		
            	</nav>
            </div>
            <div id="674" class="art_content"><p>
	想必大家对SimpleDateFormat并不陌生。SimpleDateFormat 是 <a target="_self"><u><strong>Java</strong></u></a> 中一个非常常用的类，该类用来对日期字符串进行解析和格式化输出，但如果使用不小心会导致非常微妙和难以调试的问题，因为 DateFormat 和 SimpleDateFormat 类不都是线程安全的，在多线程环境下调用 format() 和 parse() 方法应该使用同步代码来避免问题。下面我们通过一个具体的场景来一步步的深入<a target="_self">学习</a>和理解SimpleDateFormat类。</p>
<p>
	<strong>　　一、引子</strong></p>
<p>
	　　我们都是优秀的程序员，我们都知道在程序中我们应当尽量少的创建SimpleDateFormat 实例，因为创建这么一个实例需要耗费很大的代价。在一个读取<a target="_self">数据库</a>数据导出到excel文件的例子当中，每次处理一个时间信息的时候，就需要创建一个SimpleDateFormat实例对象，然后再丢弃这个对象。大量的对象就这样被创建出来，占用大量的内存和 jvm空间。代码如下：</p>
<p>
	&nbsp;</p>
<table align="center" style="BORDER-BOTTOM: #999 1px solid; BORDER-LEFT: #999 1px solid; BACKGROUND-COLOR: #dddddd; WIDTH: 98%; FONT-SIZE: 12px; BORDER-TOP: #999 1px solid; BORDER-RIGHT: #999 1px solid">
	<tbody>
		<tr>
			<td>
				<p>
					package com.peidasoft.dateformat;</p>
				<p>
					import java.text.ParseException;<br />
					import java.text.SimpleDateFormat;<br />
					import java.util.Date;</p>
				<p>
					public class DateUtil {<br />
					&nbsp;&nbsp;&nbsp;<br />
					&nbsp;&nbsp;&nbsp; public static&nbsp; String formatDate(Date date)throws ParseException{<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return sdf.format(date);<br />
					&nbsp;&nbsp;&nbsp; }<br />
					&nbsp;&nbsp;&nbsp;<br />
					&nbsp;&nbsp;&nbsp; public static Date parse(String strDate) throws ParseException{<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return sdf.parse(strDate);<br />
					&nbsp;&nbsp;&nbsp; }<br />
					}</p>
			</td>
		</tr>
	</tbody>
</table>
<p>
	　　你也许会说，OK，那我就创建一个静态的simpleDateFormat实例，然后放到一个DateUtil类（如下）中，在使用时直接使用这个实例进行操作，这样问题就解决了。改进后的代码如下：</p>
<p>
	&nbsp;</p>
<table align="center" style="BORDER-BOTTOM: #999 1px solid; BORDER-LEFT: #999 1px solid; BACKGROUND-COLOR: #dddddd; WIDTH: 98%; FONT-SIZE: 12px; BORDER-TOP: #999 1px solid; BORDER-RIGHT: #999 1px solid">
	<tbody>
		<tr>
			<td>
				<p>
					package com.peidasoft.dateformat;</p>
				<p>
					import java.text.ParseException;<br />
					import java.text.SimpleDateFormat;<br />
					import java.util.Date;</p>
				<p>
					public class DateUtil {<br />
					&nbsp;&nbsp;&nbsp; private static final&nbsp; SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);<br />
					&nbsp;&nbsp;&nbsp;<br />
					&nbsp;&nbsp;&nbsp; public static&nbsp; String formatDate(Date date)throws ParseException{<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return sdf.format(date);<br />
					&nbsp;&nbsp;&nbsp; }<br />
					&nbsp;&nbsp;&nbsp;<br />
					&nbsp;&nbsp;&nbsp; public static Date parse(String strDate) throws ParseException{</p>
				<p>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return sdf.parse(strDate);<br />
					&nbsp;&nbsp;&nbsp; }<br />
					}</p>
			</td>
		</tr>
	</tbody>
</table>
<p>
	　　当然，这个方法的确很不错，在大部分的时间里面都会<a target="_self"><u><strong>工作</strong></u></a>得很好。但当你在生产环境中使用一段时间之后，你就会发现这么一个事实：它不是线程安全的。在正常的<a target="_self"><u><strong>测试</strong></u></a>情况之下，都没有问题，但一旦在生产环境中一定负载情况下时，这个问题就出来了。他会出现各种不同的情况，比如转化的时间不正确，比如报错，比如线程被挂死等等。我们看下面的<a target="_self"><u><strong>测试用例</strong></u></a>，那事实说话：</p>
<p>
	&nbsp;</p>
<table align="center" style="BORDER-BOTTOM: #999 1px solid; BORDER-LEFT: #999 1px solid; BACKGROUND-COLOR: #dddddd; WIDTH: 98%; FONT-SIZE: 12px; BORDER-TOP: #999 1px solid; BORDER-RIGHT: #999 1px solid">
	<tbody>
		<tr>
			<td>
				<p>
					package com.peidasoft.dateformat;</p>
				<p>
					import java.text.ParseException;<br />
					import java.text.SimpleDateFormat;<br />
					import java.util.Date;</p>
				<p>
					public class DateUtil {<br />
					&nbsp;&nbsp;&nbsp;<br />
					&nbsp;&nbsp;&nbsp; private static final&nbsp; SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);<br />
					&nbsp;&nbsp;&nbsp;<br />
					&nbsp;&nbsp;&nbsp; public static&nbsp; String formatDate(Date date)throws ParseException{<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return sdf.format(date);<br />
					&nbsp;&nbsp;&nbsp; }<br />
					&nbsp;&nbsp;&nbsp;<br />
					&nbsp;&nbsp;&nbsp; public static Date parse(String strDate) throws ParseException{</p>
				<p>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return sdf.parse(strDate);<br />
					&nbsp;&nbsp;&nbsp; }<br />
					}</p>
			</td>
		</tr>
	</tbody>
</table>
<table align="center" style="BORDER-BOTTOM: #999 1px solid; BORDER-LEFT: #999 1px solid; BACKGROUND-COLOR: #dddddd; WIDTH: 98%; FONT-SIZE: 12px; BORDER-TOP: #999 1px solid; BORDER-RIGHT: #999 1px solid">
	<tbody>
		<tr>
			<td>
				<p>
					package com.peidasoft.dateformat;</p>
				<p>
					import java.text.ParseException;<br />
					import java.util.Date;</p>
				<p>
					public class DateUtilTest {<br />
					&nbsp;&nbsp;&nbsp;<br />
					&nbsp;&nbsp;&nbsp; public static class TestSimpleDateFormatThreadSafe extends Thread {<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; @Override<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void run() {<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while(true) {<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try {<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.join(2000);<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } catch (InterruptedException e1) {<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; e1.printStackTrace();<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try {<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(this.getName()+&quot;:&quot;+DateUtil.parse(&quot;2013-05-24 06:02:20&quot;));<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } catch (ParseException e) {<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; e.printStackTrace();<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;<br />
					&nbsp;&nbsp;&nbsp; }<br />
					&nbsp;&nbsp;&nbsp;<br />
					&nbsp;&nbsp;&nbsp;<br />
					&nbsp;&nbsp;&nbsp; public static void main(String[] args) {<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for(int i = 0; i &lt; 3; i++){<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; new TestSimpleDateFormatThreadSafe().start();<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
					&nbsp;&nbsp;&nbsp; }<br />
					}</p>
			</td>
		</tr>
	</tbody>
</table>
<p>
	　　执行输出如下：</p>
<p>
	&nbsp;</p>
<table align="center" style="BORDER-BOTTOM: #999 1px solid; BORDER-LEFT: #999 1px solid; BACKGROUND-COLOR: #dddddd; WIDTH: 98%; FONT-SIZE: 12px; BORDER-TOP: #999 1px solid; BORDER-RIGHT: #999 1px solid">
	<tbody>
		<tr>
			<td>
				Exception in thread &quot;Thread-1&quot; java.lang.NumberFormatException: multiple points<br />
				&nbsp;&nbsp;&nbsp; at sun.misc.FloatingDecimal.readJavaFormatString(FloatingDecimal.java:1082)<br />
				&nbsp;&nbsp;&nbsp; at java.lang.Double.parseDouble(Double.java:510)<br />
				&nbsp;&nbsp;&nbsp; at java.text.DigitList.getDouble(DigitList.java:151)<br />
				&nbsp;&nbsp;&nbsp; at java.text.DecimalFormat.parse(DecimalFormat.java:1302)<br />
				&nbsp;&nbsp;&nbsp; at java.text.SimpleDateFormat.subParse(SimpleDateFormat.java:1589)<br />
				&nbsp;&nbsp;&nbsp; at java.text.SimpleDateFormat.parse(SimpleDateFormat.java:1311)<br />
				&nbsp;&nbsp;&nbsp; at java.text.DateFormat.parse(DateFormat.java:335)<br />
				&nbsp;&nbsp;&nbsp; at com.peidasoft.orm.dateformat.DateNoStaticUtil.parse(DateNoStaticUtil.java:17)<br />
				&nbsp;&nbsp;&nbsp; at com.peidasoft.orm.dateformat.DateUtilTest$TestSimpleDateFormatThreadSafe.run(DateUtilTest.java:20)<br />
				Exception in thread &quot;Thread-0&quot; java.lang.NumberFormatException: multiple points<br />
				&nbsp;&nbsp;&nbsp; at sun.misc.FloatingDecimal.readJavaFormatString(FloatingDecimal.java:1082)<br />
				&nbsp;&nbsp;&nbsp; at java.lang.Double.parseDouble(Double.java:510)<br />
				&nbsp;&nbsp;&nbsp; at java.text.DigitList.getDouble(DigitList.java:151)<br />
				&nbsp;&nbsp;&nbsp; at java.text.DecimalFormat.parse(DecimalFormat.java:1302)<br />
				&nbsp;&nbsp;&nbsp; at java.text.SimpleDateFormat.subParse(SimpleDateFormat.java:1589)<br />
				&nbsp;&nbsp;&nbsp; at java.text.SimpleDateFormat.parse(SimpleDateFormat.java:1311)<br />
				&nbsp;&nbsp;&nbsp; at java.text.DateFormat.parse(DateFormat.java:335)<br />
				&nbsp;&nbsp;&nbsp; at com.peidasoft.orm.dateformat.DateNoStaticUtil.parse(DateNoStaticUtil.java:17)<br />
				&nbsp;&nbsp;&nbsp; at com.peidasoft.orm.dateformat.DateUtilTest$TestSimpleDateFormatThreadSafe.run(DateUtilTest.java:20)<br />
				Thread-2:Mon May 24 06:02:20 CST 2021<br />
				Thread-2:Fri May 24 06:02:20 CST 2013<br />
				Thread-2:Fri May 24 06:02:20 CST 2013<br />
				Thread-2:Fri May 24 06:02:20 CST 2013</td>
		</tr>
	</tbody>
</table>
<p>
	　　说明：Thread-1和Thread-0报java.lang.NumberFormatException: multiple points错误，直接挂死，没起来；Thread-2 虽然没有挂死，但输出的时间是有错误的，比如我们输入的时间是：2013-05-24 06:02:20 ，当会输出：Mon May 24 06:02:20 CST 2021 这样的灵异事件。</p>
<p>
	<strong>　　二、原因</strong></p>
<p>
	　　作为一个专业程序员，我们当然都知道，相比于共享一个变量的开销要比每次创建一个新变量要小很多。上面的优化过的静态的SimpleDateFormat版，之所在并发情况下回出现各种灵异错误，是因为SimpleDateFormat和DateFormat类不是线程安全的。我们之所以忽视线程安全的问题，是因为从SimpleDateFormat和DateFormat类提供给我们的接口上来看，实在让人看不出它与线程安全有何相干。只是在JDK文档的最下面有如下说明：</p>
<p>
	　　SimpleDateFormat中的日期格式不是同步的。推荐（建议）为每个线程创建独立的格式实例。如果多个线程同时访问一个格式，则它必须保持外部同步。</p>
<p>
	　　JDK原始文档如下：</p>
<p>
	　　Synchronization：<br />
	Date formats are not synchronized.<br />
	It is recommended to create separate format instances for each thread.<br />
	If multiple threads access a format concurrently, it must be synchronized externally.</p>
<p>
	&nbsp;</p>
<p>
	下面我们通过看JDK源码来看看为什么SimpleDateFormat和DateFormat类不是线程安全的真正原因：</p>
<p>
	　　SimpleDateFormat继承了DateFormat,在DateFormat中定义了一个protected属性的 Calendar类的对象：calendar。只是因为Calendar累的概念复杂，牵扯到时区与本地化等等，Jdk的实现中使用了成员变量来传递参数，这就造成在多线程的时候会出现错误。</p>
<p>
	　　在format方法里，有这样一段代码：</p>
<p>
	&nbsp;</p>
<table align="center" style="BORDER-BOTTOM: #999 1px solid; BORDER-LEFT: #999 1px solid; BACKGROUND-COLOR: #dddddd; WIDTH: 98%; FONT-SIZE: 12px; BORDER-TOP: #999 1px solid; BORDER-RIGHT: #999 1px solid">
	<tbody>
		<tr>
			<td>
				<p>
					private StringBuffer format(Date date, StringBuffer toAppendTo,<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FieldDelegate delegate) {<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Convert input date to time field list<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; calendar.setTime(date);</p>
				<p>
					&nbsp;&nbsp;&nbsp; boolean useDateFormatSymbols = useDateFormatSymbols();</p>
				<p>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for (int i = 0; i &lt; compiledPattern.length; ) {<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int tag = compiledPattern[i] &gt;&gt;&gt; 8;<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int count = compiledPattern[i++] &amp; 0xff;<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (count == 255) {<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; count = compiledPattern[i++] &lt;&lt; 16;<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; count |= compiledPattern[i++];<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
				<p>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; switch (tag) {<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case TAG_QUOTE_ASCII_CHAR:<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; toAppendTo.append((char)count);<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;</p>
				<p>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case TAG_QUOTE_CHARS:<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; toAppendTo.append(compiledPattern, i, count);<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; i += count;<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;</p>
				<p>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default:<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; subFormat(tag, count, delegate, toAppendTo, useDateFormatSymbols);<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
					&nbsp;&nbsp;&nbsp; }<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return toAppendTo;<br />
					&nbsp;&nbsp;&nbsp; }</p>
			</td>
		</tr>
	</tbody>
</table>
<p>
	　　calendar.setTime(date)这条语句改变了calendar，稍后，calendar还会用到（在subFormat方法里），而这就是引发问题的根源。想象一下，在一个多线程环境下，有两个线程持有了同一个SimpleDateFormat的实例，分别调用format方法：</p>
<p>
	　　线程1调用format方法，改变了calendar这个字段。</p>
<p>
	　　中断来了。</p>
<p>
	　　线程2开始执行，它也改变了calendar。</p>
<p>
	　　又中断了。</p>
<p>
	　　线程1回来了，此时，calendar已然不是它所设的值，而是走上了线程2设计的道路。如果多个线程同时争抢calendar对象，则会出现各种问题，时间不对，线程挂死等等。</p>
<p>
	　　分析一下format的实现，我们不难发现，用到成员变量calendar，唯一的好处，就是在调用subFormat时，少了一个参数，却带来了这许多的问题。其实，只要在这里用一个局部变量，一路传递下去，所有问题都将迎刃而解。</p>
<p>
	　　这个问题背后隐藏着一个更为重要的问题--无状态：无状态方法的好处之一，就是它在各种环境下，都可以安全的调用。衡量一个方法是否是有状态的，就看它是否改动了其它的东西，比如全局变量，比如实例的字段。format方法在运行过程中改动了SimpleDateFormat的calendar字段，所以，它是有状态的。</p>
<p>
	　　这也同时提醒我们在开发和设计系统的时候注意下一下三点:</p>
<p>
	　　1、自己写公用类的时候，要对多线程调用情况下的后果在注释里进行明确说明</p>
<p>
	　　2、对线程环境下，对每一个共享的可变变量都要注意其线程安全性</p>
<p>
	　　3、我们的类和方法在做设计的时候，要尽量设计成无状态的</p>
<p>
	<strong>　　三、解决办法</strong></p>
<p>
	　　1、需要的时候创建新实例：</p>
<p>
	&nbsp;</p>
<table align="center" style="BORDER-BOTTOM: #999 1px solid; BORDER-LEFT: #999 1px solid; BACKGROUND-COLOR: #dddddd; WIDTH: 98%; FONT-SIZE: 12px; BORDER-TOP: #999 1px solid; BORDER-RIGHT: #999 1px solid">
	<tbody>
		<tr>
			<td>
				<p>
					package com.peidasoft.dateformat;</p>
				<p>
					import java.text.ParseException;<br />
					import java.text.SimpleDateFormat;<br />
					import java.util.Date;</p>
				<p>
					public class DateUtil {<br />
					&nbsp;&nbsp;&nbsp;<br />
					&nbsp;&nbsp;&nbsp; public static&nbsp; String formatDate(Date date)throws ParseException{<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return sdf.format(date);<br />
					&nbsp;&nbsp;&nbsp; }<br />
					&nbsp;&nbsp;&nbsp;<br />
					&nbsp;&nbsp;&nbsp; public static Date parse(String strDate) throws ParseException{<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return sdf.parse(strDate);<br />
					&nbsp;&nbsp;&nbsp; }<br />
					}</p>
			</td>
		</tr>
	</tbody>
</table>
<p>
	　　说明：在需要用到SimpleDateFormat 的地方新建一个实例，不管什么时候，将有线程安全问题的对象由共享变为局部私有都能避免多线程问题，不过也加重了创建对象的负担。在一般情况下，这样其实对性能影响比不是很明显的。</p>
<p>
	&nbsp;</p>
<p>
	2、使用同步：同步SimpleDateFormat对象</p>
<p>
	&nbsp;</p>
<table align="center" style="BORDER-BOTTOM: #999 1px solid; BORDER-LEFT: #999 1px solid; BACKGROUND-COLOR: #dddddd; WIDTH: 98%; FONT-SIZE: 12px; BORDER-TOP: #999 1px solid; BORDER-RIGHT: #999 1px solid">
	<tbody>
		<tr>
			<td>
				<p>
					package com.peidasoft.dateformat;</p>
				<p>
					import java.text.ParseException;<br />
					import java.text.SimpleDateFormat;<br />
					import java.util.Date;</p>
				<p>
					public class DateSyncUtil {</p>
				<p>
					&nbsp;&nbsp;&nbsp; private static SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
					&nbsp;&nbsp;&nbsp; public static String formatDate(Date date)throws ParseException{<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; synchronized(sdf){<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return sdf.format(date);<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;<br />
					&nbsp;&nbsp;&nbsp; }<br />
					&nbsp;&nbsp;&nbsp;<br />
					&nbsp;&nbsp;&nbsp; public static Date parse(String strDate) throws ParseException{<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; synchronized(sdf){<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return sdf.parse(strDate);<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
					&nbsp;&nbsp;&nbsp; }<br />
					}</p>
			</td>
		</tr>
	</tbody>
</table>
<p>
	　　说明：当线程较多时，当一个线程调用该方法时，其他想要调用此方法的线程就要block，多线程并发量大的时候会对性能有一定的影响。</p>
<p>
	　　3、使用ThreadLocal：</p>
<p>
	&nbsp;</p>
<table align="center" style="BORDER-BOTTOM: #999 1px solid; BORDER-LEFT: #999 1px solid; BACKGROUND-COLOR: #dddddd; WIDTH: 98%; FONT-SIZE: 12px; BORDER-TOP: #999 1px solid; BORDER-RIGHT: #999 1px solid">
	<tbody>
		<tr>
			<td>
				<p>
					package com.peidasoft.dateformat;</p>
				<p>
					import java.text.DateFormat;<br />
					import java.text.ParseException;<br />
					import java.text.SimpleDateFormat;<br />
					import java.util.Date;</p>
				<p>
					public class ConcurrentDateUtil {</p>
				<p>
					&nbsp;&nbsp;&nbsp; private static ThreadLocal&lt;DateFormat&gt; threadLocal = new ThreadLocal&lt;DateFormat&gt;() {<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; @Override<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected DateFormat initialValue() {<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
					&nbsp;&nbsp;&nbsp; };</p>
				<p>
					&nbsp;&nbsp;&nbsp; public static Date parse(String dateStr) throws ParseException {<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return threadLocal.get().parse(dateStr);<br />
					&nbsp;&nbsp;&nbsp; }</p>
				<p>
					&nbsp;&nbsp;&nbsp; public static String format(Date date) {<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return threadLocal.get().format(date);<br />
					&nbsp;&nbsp;&nbsp; }<br />
					}</p>
			</td>
		</tr>
	</tbody>
</table>
<p>
	&nbsp;</p>
<p>
	　另外一种写法：</p>
<p>
	&nbsp;</p>
<table align="center" style="BORDER-BOTTOM: #999 1px solid; BORDER-LEFT: #999 1px solid; BACKGROUND-COLOR: #dddddd; WIDTH: 98%; FONT-SIZE: 12px; BORDER-TOP: #999 1px solid; BORDER-RIGHT: #999 1px solid">
	<tbody>
		<tr>
			<td>
				<p>
					package com.peidasoft.dateformat;</p>
				<p>
					import java.text.DateFormat;<br />
					import java.text.ParseException;<br />
					import java.text.SimpleDateFormat;<br />
					import java.util.Date;</p>
				<p>
					public class ThreadLocalDateUtil {<br />
					&nbsp;&nbsp;&nbsp; private static final String date_format = &quot;yyyy-MM-dd HH:mm:ss&quot;;<br />
					&nbsp;&nbsp;&nbsp; private static ThreadLocal&lt;DateFormat&gt; threadLocal = new ThreadLocal&lt;DateFormat&gt;();<br />
					&nbsp;<br />
					&nbsp;&nbsp;&nbsp; public static DateFormat getDateFormat()&nbsp;&nbsp;<br />
					&nbsp;&nbsp;&nbsp; {&nbsp;<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DateFormat df = threadLocal.get();&nbsp;<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(df==null){&nbsp;<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; df = new SimpleDateFormat(date_format);&nbsp;<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; threadLocal.set(df);&nbsp;<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return df;&nbsp;<br />
					&nbsp;&nbsp;&nbsp; }&nbsp;</p>
				<p>
					&nbsp;&nbsp;&nbsp; public static String formatDate(Date date) throws ParseException {<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return getDateFormat().format(date);<br />
					&nbsp;&nbsp;&nbsp; }</p>
				<p>
					&nbsp;&nbsp;&nbsp; public static Date parse(String strDate) throws ParseException {<br />
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return getDateFormat().parse(strDate);<br />
					&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;<br />
					}</p>
			</td>
		</tr>
	</tbody>
</table>
<p>
	　　说明：使用ThreadLocal, 也是将共享变量变为独享，线程独享肯定能比方法独享在并发环境中能减少不少创建对象的开销。如果对性能要求比较高的情况下，一般推荐使用这种方法。</p>
<p>
	　　4、抛弃JDK，使用其他类库中的时间格式化类：</p>
<p>
	　　1）使用Apache commons 里的FastDateFormat，宣称是既快又线程安全的SimpleDateFormat, 可惜它只能对日期进行format, 不能对日期串进行解析。</p>
<p>
	　　2）使用Joda-Time类库来处理时间相关问题</p>
<p>
	　　做一个简单的压力测试，方法一最慢，方法三最快，但是就算是最慢的方法一性能也不差，一般系统方法一和方法二就可以满足，所以说在这个点很难成为你系统的瓶颈所在。从简单的角度来说，建议使用方法一或者方法二，如果在必要的时候，追求那么一点性能提升的话，可以考虑用方法三，用ThreadLocal做缓存。</p>
<p>
	　　Joda-Time类库对时间处理方式比较完美，建议使用。</p>
</div>
  		  <!-- 将此标记放在您希望显示like按钮的位置 -->          
            <div class="art_like"><div class="bdlikebutton"></div></div>
          </div>
        </div>
      </div>
      <div class="pnum">
        <div class="pages mypagelist">
          <div></div>
        </div>
      </div>
      <div class="pre_next">
        <nav>
          <ul class="pager">
            <li class="previous"></li>
            <li class="next"></li>
          </ul>
        </nav>
      </div>
      <div class="well"> 
    		如果你有好的<a href="http://www.win10os.com/win10zixun" title="win10资讯">win10资讯</a>或者<a href="http://www.win10os.com/win10jiqiao" title="win10教程">win10教程</a>，以及<a href="http://www.win10os.com/win10xitong" title="win10">win10</a>相关的问题想要获得<a href="http://www.win10os.com/win10xiazai" title="win10系统下载">win10系统下载</a>的关注与报道。<br/>欢迎加入发送邮件到657025171#qq.com(#替换为@)。期待你的好消息！
    	</div>
    </div>
    <!--右侧部分-->
    <div class="col-sm-4 col-md-4">
      <script src='/plus/ad_js.php?aid=12' language='javascript'></script>
      <div class="panel panel-custom panel-custom-right">
        <div class="panel-heading">最新文章>>></div>
        <div class="panel-body">
          <ul class="all_list">
            <li><a href='/bcsj/java/42949670.html'>《RocketMq》七、Broker中心节点</a></li><li><a href='/bcsj/java/59451787.html'>《RocketMq》六、Client－Consumer消费者详解</a></li><li><a href='/bcsj/java/93478184.html'>《RocketMq》五、Client－Producer生产者详解</a></li><li><a href='/bcsj/java/16882015.html'>《RocketMq》四、Client Producer/Consumer总览</a></li><li><a href='/bcsj/java/66636302.html'>《RocketMq》三、NameServer</a></li><li><a href='/bcsj/java/91963739.html'>《RocketMq》二、存储篇</a></li><li><a href='/bcsj/java/36422446.html'>《RocketMq》一、网络传输篇</a></li><li><a href='/bcsj/java/69287988.html'>linux jar包启动脚本</a></li><li><a href='/bcsj/java/89472738.html'>nginx 反向代理oss</a></li><li><a href='/bcsj/java/43423861.html'>细粒度 自定义注解 权限控制具体实现</a></li>
          </ul>
        </div>
      </div>  
      <script src='/plus/ad_js.php?aid=14' language='javascript'></script>
      <div id="scr_cont" class="panel panel-custom panel-custom-right">
        <div class="panel-heading">相关文章>>></div>
        <div class="panel-body">
          <ul class="all_list">
            <li><a href='/bcsj/java/1459.html'>maven国内快速镜像中央仓库地址,Aliyun镜像,OSChina镜像</a></li><li><a href='/bcsj/java/1439.html'>SpringMVC+JSP企业支付宝账号开发接口教程</a></li><li><a href='/bcsj/java/452.html'>在MyEclipse中搭建Spring MVC开发环境</a></li><li><a href='/bcsj/java/1365.html'>Java虚拟机(JVM)以及跨平台原理</a></li><li><a href='/bcsj/java/128.html'>错误整理：No plugin found for prefix 'jetty' in the current proje</a></li><li><a href='/bcsj/java/152.html'>HTTP大文件上传断点续传控件发布-Xproer.HttpUploader5</a></li><li><a href='/bcsj/java/1548.html'>Spring使用支付宝扫码支付</a></li><li><a href='/bcsj/java/1440.html'>JAVA环境变量JAVA_HOME、CLASSPATH、PATH设置详解</a></li><li><a href='/bcsj/java/728.html'>Java开发工具</a></li><li><a href='/bcsj/java/1362.html'>web service对外发布一个hello world接口</a></li>
          </ul>
          </ul>
        </div>
      </div>
      <div class="ad"></div>
    </div>
    
  </div>
  <nav class="navbar navbar-default navbar-fixed-bottom navbar-bottom-custom">
    <div class="container">
      <span class="pull-right navbar-text" id="font_smaller" onclick="changeFont('smaller')">A-</span>&nbsp;&nbsp;<span class="pull-right navbar-text" id="font_bigger" onclick="changeFont('bigger')">A+</span>
    </div>
  </nav>
  <div class="footer">
    <div class="foot">
      <br>
      一起学编程是一家纯计算机技术学习、电脑学习、IT技术学习交流型网站，一起学编程所载文章来源于网络，如果不慎侵犯了您的权益，请联系我们删除！站长QQ：657025171<br>
      <a href="/aboutus.html">关于我们</a> | <a href="/dashiji.html">大事记</a> | <a href="/jiazhiguan.html">网站价值观</a> | <a href="/contactus.html">联系我们</a> | <a href="/sitemap.xml">网站地图</a> | <a href="/copyright.html">版权声明</a><br>
      Copyright ◎ 2011 - 2023 yqxbc.com All Rights Reserved.<br>
      yqxbc.com 版权所有 京ICP备11048740号-7<br>

    </div>
  </div>
  <script src="/templets/default/js/jquery-2.1.3.js"></script>
  <script src="/templets/default/js/bootstrap.min.js"></script>
  <script src="/templets/default/js/docs.min.js"></script>
  <script src="/templets/default/js/main.js"></script>
  <script src="/templets/default/js/header.js"></script>
  <script src="/templets/default/js/article.js"></script>
  <script src="/templets/default/js/page-dir.js"></script>
  <script type="text/javascript">
    document.getElementById('count').innerHTML = document.getElementById('count_data').innerHTML;
      var img = $(".art_content p").find("img")
      $.each(img,function(index,el){
        el.style.width='100%';
      });
  </script>
  <!-- 将此代码放在适当的位置，建议在body结束前 -->
  <script id="bdlike_shell"></script>
  <script>
    var bdShare_config = {"type":"large","color":"blue","likeText":"内容很精彩","likedText":"您已顶过，谢谢！"};
    document.getElementById("bdlike_shell").src="http://bdimg.share.baidu.com/static/js/like_shell.js?t=" + Math.ceil(new Date()/3600000);
  </script>
</body>
</html>
